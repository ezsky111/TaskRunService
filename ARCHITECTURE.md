# 项目架构说明

## 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                    用户浏览器                             │
│              (Vue 3 Web应用 - 5000端口)                 │
└────────────────────────┬────────────────────────────────┘
                         │ HTTP/WebSocket
                         │
┌────────────────────────▼────────────────────────────────┐
│                   反向代理/负载均衡                      │
│                 (可选: Nginx)                           │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────┐
│                                                          │
│              Docker容器 - Task Run Service              │
│                                                          │
│  ┌────────────────────────────────────────────────┐    │
│  │           Flask Web应用 (Python)               │    │
│  │                                                │    │
│  │  ┌──────────────────────────────────────┐    │    │
│  │  │    Vue前端应用 (dist/ 静态文件)     │    │    │
│  │  └──────────────────────────────────────┘    │    │
│  │                                                │    │
│  │  ┌───────────┐  ┌──────────┐  ┌──────────┐  │    │
│  │  │  Task     │  │   Log    │  │ System   │  │    │
│  │  │ Routes    │  │ Routes   │  │ Routes   │  │    │
│  │  └──────┬────┘  └────┬─────┘  └────┬─────┘  │    │
│  │         │            │             │        │    │
│  │         └────────────┴─────────────┘        │    │
│  │                  │                          │    │
│  │  ┌──────────────▼──────────────┐            │    │
│  │  │   Task Manager              │            │    │
│  │  │  - 任务执行                 │            │    │
│  │  │  - 进程锁管理               │            │    │
│  │  │  - 日志记录                 │            │    │
│  │  └──────────────┬──────────────┘            │    │
│  │                 │                           │    │
│  │                 ├─────────────────┐        │    │
│  │                 │                 │        │    │
│  │  ┌──────────────▼──┐  ┌──────────▼──┐    │    │
│  │  │ 线程执行引擎    │  │ ProcessLock │    │    │
│  │  │ (subprocess)   │  │ (进程唯一性) │    │    │
│  │  └──────────────┬──┘  └──────────────┘    │    │
│  │                 │                          │    │
│  │  ┌──────────────▼──────────────┐            │    │
│  │  │   Process Manager            │            │    │
│  │  │  - CPU/内存监控             │            │    │
│  │  │  - 进程信息获取             │            │    │
│  │  └──────────────────────────────┘            │    │
│  │                                                │    │
│  └────────────────────────────────────────────────┘    │
│                                                          │
│  ┌────────────────────────────────────────────────┐    │
│  │         文件系统                                │    │
│  │  ┌──────────────┐  ┌──────────────────────┐   │    │
│  │  │ /app/tasks   │  │  /app/logs           │   │    │
│  │  │              │  │                      │   │    │
│  │  │ - hello.py   │  │ - app.log            │   │    │
│  │  │ - data_proc  │  │ - task_run_id.log    │   │    │
│  │  │ - user_task  │  │ - ...                │   │    │
│  │  └──────────────┘  └──────────────────────┘   │    │
│  └────────────────────────────────────────────────┘    │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

## 模块结构

### 前端（Vue 3 + Vite）

```
frontend/
├── src/
│   ├── views/              # 页面组件
│   │   ├── TaskList       # 任务列表和管理
│   │   ├── TaskEditor     # 任务编辑器
│   │   ├── TaskLogs       # 日志查看
│   │   └── SystemMonitor  # 系统监控
│   ├── api/               # API通信层
│   │   └── index.js       # Axios实例和API方法
│   ├── App.vue            # 根组件
│   ├── router.js          # 路由配置
│   └── main.js            # 应用入口
└── dist/                  # 构建输出（Docker中打包）
```

### 后端（Flask + Python）

```
backend/
├── app/
│   ├── core/              # 核心业务逻辑
│   │   ├── config.py      # 应用配置（环境变量）
│   │   ├── task_manager.py     # 任务管理核心
│   │   │   ├── list_tasks()     # 列出任务
│   │   │   ├── execute_task()   # 执行任务
│   │   │   ├── get_task_status()# 获取状态
│   │   │   └── _execute_task_thread() # 后台执行
│   │   └── process_manager.py   # 进程监控
│   │       ├── get_system_info()     # 系统信息
│   │       └── get_all_processes()   # 进程列表
│   │
│   ├── routes/            # API路由层
│   │   ├── task_routes.py      # 任务接口
│   │   ├── log_routes.py       # 日志接口
│   │   └── system_routes.py    # 系统接口
│   │
│   ├── utils/             # 工具模块
│   │   ├── logger.py           # 日志工具
│   │   └── process_lock.py     # 进程锁（关键）
│   │       ├── acquire_lock()      # 获取锁
│   │       ├── release_lock()      # 释放锁
│   │       └── is_task_running()   # 检查运行状态
│   │
│   ├── models/            # 数据模型（可扩展）
│   ├── services/          # 业务服务（可扩展）
│   └── __init__.py        # Flask应用工厂
│
└── run.py                 # 启动脚本
```

## 关键流程

### 1. 任务执行流程

```
用户提交执行请求
        │
        ▼
检查任务是否存在 (task_manager.execute_task)
        │
        ├─ 否 ──► 返回错误
        │
        ├─ 是
        │
        ▼
检查进程锁 (process_lock.is_task_running)
        │
        ├─ 任务已运行 ──► 返回错误："任务已在执行"
        │
        ├─ 未运行
        │
        ▼
获取进程锁 (process_lock.acquire_lock)
        │
        ├─ 获取失败 ──► 返回错误
        │
        ├─ 获取成功
        │
        ▼
启动后台线程 (_execute_task_thread)
        │
        ├─ 设置任务状态为"running"
        ├─ 执行Python脚本 (subprocess.run)
        ├─ 捕获输出到日志文件
        ├─ 设置任务状态为"success/failed/timeout/error"
        ├─ 释放进程锁 (process_lock.release_lock)
        │
        ▼
返回 run_id 给用户
```

### 2. 进程锁机制

```
执行任务A时：
┌─────────────────────────────────────┐
│ tasks.lock = {                      │
│   'task_a': threading.Lock()        │
│ }                                   │
│                                     │
│ 当再次执行任务A时：                 │
│ - acquire_lock('task_a')            │
│ - Lock已被获取，返回False           │
│ - 拒绝执行                          │
│                                     │
│ 任务A完成后：                       │
│ - release_lock('task_a')            │
│ - 从lock字典中移除'task_a'          │
│ - 可以再次执行                      │
└─────────────────────────────────────┘
```

### 3. 日志记录流程

```
任务执行中
    │
    ├─ stdout/stderr
    │    │
    │    ▼
    └─► 日志文件: {LOGS_DIR}/{task_id}_{run_id}.log
         │
         ├─ 用户通过API查看: GET /api/logs/{task_id}_{run_id}.log
         ├─ 用户通过Web下载: /logs/{task_id}_{run_id}.log/download
         └─ 应用日志: {LOGS_DIR}/app.log
```

## 数据流

### 前端到后端

```
TaskList.vue
    │
    ├─ 列表操作 ──► axios.get('/api/tasks')
    ├─ 创建 ──────► axios.post('/api/tasks', data)
    ├─ 执行 ──────► axios.post('/api/tasks/{id}/execute')
    ├─ 查看日志 ──► axios.get('/api/logs/{id}_{run_id}.log')
    └─ 监控 ──────► axios.get('/api/system/info')
                    │
                    ▼
            Flask Backend
                    │
                    ├─ 数据库处理（当前版本基于文件）
                    ├─ 业务逻辑处理
                    ├─ 文件系统操作
                    └─ 进程管理
                    │
                    ▼
            返回JSON响应
```

## 并发模型

### 当前支持的并发

```
最多同时执行5个任务（可配置 MAX_TASK_WORKERS）

Task1 ─────────────► 线程1 ─► Python进程1
Task2 ─────────────► 线程2 ─► Python进程2
Task3 ─────────────► 线程3 ─► Python进程3
Task4 ─────────────► 线程4 ─► Python进程4
Task5 ─────────────► 线程5 ─► Python进程5
Task6 ─────────────► 等待 (超过限制，返回错误)

同一任务被保护：
TaskA ──┐
        ├─► ProcessLock["TaskA"] ──► 锁定
TaskA ──┘                             ← 拒绝执行
```

## 扩展性设计

### 模块化结构

- **routes/**: 可轻松添加新的API端点
- **core/**: 业务逻辑独立，易于测试和修改
- **utils/**: 可复用工具，支持扩展
- **services/**: 预留位置，用于添加高级业务逻辑
- **models/**: 预留位置，用于数据持久化

### 可以扩展的功能

1. **数据库支持**: 添加SQLAlchemy进行任务历史记录
2. **用户认证**: 集成JWT或OAuth2
3. **任务调度**: 集成APScheduler进行定时任务
4. **Webhook**: 任务完成后的回调通知
5. **分布式执行**: 支持多机器的任务分发
6. **任务编排**: DAG支持，支持复杂工作流

## 性能考虑

### 优化点

1. **多线程执行**: 不阻塞主应用
2. **进程隔离**: 每个任务独立进程，防止崩溃污染
3. **日志流式写入**: 实时捕获输出
4. **内存管理**: 及时清理已完成的任务记录
5. **异步操作**: 前端长轮询获取状态

### 限制因素

1. **单机限制**: 所有任务运行在同一容器内
2. **内存占用**: 任务数量受限于可用内存
3. **磁盘I/O**: 大量日志写入可能成为瓶颈
4. **进程数**: OS限制的进程数

## 安全性

### 当前的安全考虑

1. **进程隔离**: 每个任务独立进程
2. **超时保护**: 防止无限执行
3. **资源限制**: 可配置的并发任务数
4. **日志审计**: 所有操作都有记录

### 建议的安全增强

1. 添加用户认证和授权
2. 实现操作审计日志
3. 代码检查和沙箱执行
4. 敏感数据加密存储
5. API速率限制和防DDoS

## 部署拓扑

### 单机部署

```
┌──────────────────┐
│   用户浏览器      │
└────────┬─────────┘
         │
    HTTP│5000
         │
┌────────▼─────────┐
│  Docker容器      │
│  Task服务        │
└──────────────────┘
```

### Nginx反向代理部署

```
┌──────────────────┐
│   用户浏览器      │
└────────┬─────────┘
         │
     HTTP│HTTPS
         │
┌────────▼─────────┐
│   Nginx           │
│  (反向代理)       │
└────────┬─────────┘
         │
    HTTP│
         │
┌────────▼─────────┐
│  Docker容器      │
│  Task服务        │
└──────────────────┘
```

### 集群部署（未来）

```
┌──────────────────┐
│   用户浏览器      │
└────────┬─────────┘
         │
┌────────▼──────────────────┐
│   Load Balancer (Nginx)    │
└────────┬───────────────────┘
         │
    ┌────┼────┐
    │    │    │
┌───▼──┐│┌──▼───┐
│ Pod1 ││ Pod2  │ Pod3...
│Task  ││Task   │ Task
└──────┘└───────┘

共享存储（NFS/MinIO）
   - /tasks
   - /logs
```
